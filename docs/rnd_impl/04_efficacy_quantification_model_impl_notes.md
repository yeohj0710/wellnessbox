# 이 문서의 성격

- 본 문서는 `docs/rnd/04_efficacy_quantification_model.md`(요구사항)를 구현할 때 참고하는 “선택 가이드”다.
- 구현 방식(통계 모델/ML/규칙 기반, 데이터 전처리/표준화 방식, 저장소 구조 등)은 강제하지 않는다.
- 충돌 시 우선순위: AGENTS.md Guardrails > docs/rnd/_ > docs/rnd_impl/_

# 구현 관점의 최소 성공 조건

- “전(pre)–후(post) 비교”가 가능한 입력(측정치 + 개입(복용))이 주어지면,
  1. 사용자별 표준화 점수(또는 동등한 평가용 값)를 산출하고
  2. `docs/rnd/01_kpi_and_evaluation.md`의 개선도(pp) 계산에 필요한 값을 제공하며
  3. 동일 입력에서 동일 결과가 재현되도록(버전/규칙/기간 기록) 로그를 남길 수 있어야 한다.

# 데이터 불확실성(측정치 종류/단위/빈도 미확정) 대응 원칙

- “측정 지표”는 플러그인처럼 추가/교체될 수 있다고 가정한다.
- 지표별로 (단위, 방향성, 정상 범위, 결측 처리, 표준화 방법)을 메타로 분리해 둔다.
- 모델/계산 로직은 “지표 메타 + 관측치 시계열”만 받도록 하면, 신규 지표가 와도 영향이 작다.

# 전/후(pre/post) 정의(평가 재현성 핵심)

- 평가가 흔들리는 가장 큰 원인은 pre/post 기간 정의가 매번 달라지는 것이다.
- 권장:
  - pre_window: 추천/복용 시작 전 일정 기간(예: X일) 또는 특정 기준일 이전 N회 측정
  - post_window: 추천/복용 시작 후 일정 기간(예: Y일) 또는 특정 기준일 이후 N회 측정
  - inclusion_rule: 최소 측정 횟수, 최소 순응도(복용 지속) 조건
- 무엇을 선택하든 “정의가 코드/설정으로 고정”되고, 결과 로그에 함께 남아야 한다.

# 표준화(정규화) 설계 힌트

- 서로 다른 지표를 합치려면 “표준화 규칙(standardization rule)”이 필요하다.
- 권장 구성(강제 아님):
  - metric_id: 지표 식별자(예: sleep_duration, resting_hr, glucose_mean 등)
  - direction: 높을수록 좋음/나쁨/중간이 좋음 등
  - transform: 원값→정규화 점수 변환(예: z-score, percentile, min-max 등)
  - reference_population: 기준 분포(내부/외부, 버전 포함)
- KPI 식 자체는 01 문서의 정의를 따른다. 따라서 “Phi(z)” 형태를 쓴다면 z 산출 규칙이 고정되어야 한다.

# 결측/이상치 처리(실무에서 제일 많이 깨짐)

- 결측이 많은 사용자는 평가에서 제외되거나, 별도의 처리 규칙이 필요하다.
- 권장:
  - missing_policy: exclude / impute(단순) / carry-forward 등
  - outlier_policy: winsorize / clip / exclude
  - compliance_policy: 복용 순응도 부족 시 제외/감점/별도 그룹
- 중요한 건 “어떤 정책을 썼는지”가 결과에 함께 저장되어 재현 가능해야 한다.

# 출력 포맷(평가/집계가 쉬운 형태 힌트)

- 사용자 단위 결과 레코드에 최소 아래가 있으면 01 문서 KPI를 계산하기 쉽다.
  - user_id (또는 가명화 키)
  - pre_value / post_value (지표별 또는 통합)
  - z_pre / z_post (또는 평가식에 해당하는 값)
  - delta_z, pp_delta (가능하면)
  - windows (pre_window, post_window), metric_set_version
  - exclusion_reason (제외 시)
  - run_id / model_version / transform_version

# 효과 개선도(pp) KPI와의 연결(운영 힌트)

- 01 문서에서 요구하는 KPI는 “평균 개선도”다.
- 따라서 배치 평가 시:
  - cohort 정의(대상 사용자 집합) + 기간 + 동일한 변환 규칙
  - 결과를 user-level로 저장하고, 집계를 별도 단계에서 수행하면 감사/재현이 쉬워진다.

# 개인화/ITE 확장(선택적 방향)

- 계획서에는 개인별 반응 차이를 다루는 방향(효과 추정, 개인 맞춤)이 포함될 수 있다.
- 구현을 강제하지 않되, 아래처럼 확장 포인트를 남겨두면 나중에 바꾸기 쉽다.
  - treatment(개입) 정의를 명확히(추천 조합/용량/기간)
  - outcome(결과) 지표를 명확히(어떤 지표를 개선으로 보나)
  - confounder(교란) 후보를 메타로 관리(연령/기저질환/기초 수준 등)
- 단, 지금 단계에서는 KPI 재현이 가능한 “전/후 표준화 + pp 계산 지원”이 우선이다.

# 개인정보/민감정보

- 측정치(건강 수치)와 복용 이력은 민감정보가 될 수 있다.
- 최소 권장:
  - 결과 저장 시 가명화 키 사용 가능하도록 설계
  - 원문 값은 최소화(필요 시만)
  - 접근 통제/감사 로그 유지

# 완료 체크리스트(구현팀용)

- pre/post 기간 정의가 명확하고 결과에 함께 기록된다.
- 지표별 표준화 규칙(버전)이 존재하고 결과에 함께 기록된다.
- user-level 결과가 저장되어 01 문서 KPI 계산을 재현 가능하게 한다.
- 결측/이상치/순응도 처리 정책이 명시되고 결과에 함께 기록된다.
