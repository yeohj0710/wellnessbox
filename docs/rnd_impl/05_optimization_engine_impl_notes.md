# 이 문서의 성격

- 본 문서는 `docs/rnd/05_optimization_engine.md`(요구사항)를 구현할 때 참고하는 “선택 가이드”다.
- 구현 방식(수학적 최적화/휴리스틱/검색/학습 기반, 라이브러리, 저장 방식)은 강제하지 않는다.
- 충돌 시 우선순위: AGENTS.md Guardrails > docs/rnd/_ > docs/rnd_impl/_

# 구현 관점의 최소 성공 조건

- 사용자 입력(목표/제약/개인 특성) + 후보 아이템(제품/성분) + 안전 제약이 주어지면,
  1. 안전 제약을 위반하지 않는 조합 후보(Top-k)를 산출하고
  2. 각 후보에 대해 “효과/비용/부작용 부담”과 연관된 점수(또는 랭킹 근거)를 남기며
  3. 추천 정확도 KPI(01 문서) 평가에 필요한 “성분 집합 비교 단위”를 제공하고
  4. 동일 입력에서 동일 결과가 재현 가능하도록 버전/로그를 남길 수 있어야 한다.

# 데이터 불확실성(제품/성분/가격/용량 구조 미확정) 대응 원칙

- Canonical 계약(02_data_lake_impl_notes의 Product/Ingredient/Evidence/Rule)을 기준으로 엔진을 설계한다.
- 가격/용량/효과 신호는 “없을 수도 있다”고 가정하고, 없을 때도 동작 가능한 기본 경로를 둔다.
- 외부 데이터가 확정되면 “입력 어댑터(매핑)”만 교체해도 엔진 코어는 유지되도록 경계를 둔다.

# 문제 정의(개념)

- 입력:
  - 후보 아이템 집합 I (제품 또는 성분 단위)
  - 사용자 상태 U
  - 안전 제약 C_safety (03 결과)
  - 예산/선호 제약 C_pref (선택)
  - 효과 신호 E (04/근거/학습 신호; 선택)
- 출력:
  - Top-k 조합 S_1..S_k (각 S는 I의 부분집합)
  - 후보별 점수 및 근거(재현 가능한 형태)

# 다목적 최적화(효과/비용/부작용 부담) 구현 힌트(강제 아님)

아래 중 무엇을 쓰든, “후보별 점수/근거”가 로그로 남아야 평가/디버깅이 쉽다.

## 1) 가중합(Weighted Sum)

- score(S) = w_eff _ Eff(S) - w_cost _ Cost(S) - w_risk \* Risk(S)
- 장점: 단순, 빠름
- 유의: 가중치(w\_\*)는 버전/설정으로 관리(로그에 남김)

## 2) 제약 최적화(Constraint-first)

- 1차: 안전 제약 충족(필수)
- 2차: 예산/복용 편의성 등 제약 충족(가능하면)
- 3차: 효과 최대화(또는 비용/부작용 최소화)
- 장점: 안전 우선 원칙 명확

## 3) 파레토(Non-dominated) 후보 + 후처리 랭킹

- Eff/Cost/Risk 3차원에서 파레토 프런티어를 구한 뒤, 사용자 선호로 최종 랭킹
- 장점: 사용자 선택 UX에 유리(“효과형/가성비형/저위험형” 등)

# 안전 제약 적용(가장 중요한 필터)

- 안전 제약은 “탐색 전/탐색 중/탐색 후” 어디서든 적용 가능하나, 최소한 아래는 보장해야 한다.
  - 금지 성분 포함 조합은 배제
  - 상한/용량/중복 제약이 있는 경우, 위반 조합 배제 또는 경고 분리
- 구현 힌트:
  - 사전 필터: 금지 성분/금지 제품을 후보에서 제거
  - 조합 생성 중 가지치기: 부분 조합 단계에서 이미 위반이면 확장 중단
  - 사후 검증: 최종 후보에 대해 안전 엔진(03)을 재호출해 검증 로그 남김(선택)

# 탐색 공간이 커질 때(실무 팁)

- 후보 수가 커지면 완전탐색은 불가능해진다.
- 흔히 쓰는 전략(강제 아님):
  - 후보 축소: 사용자 목표/태그 기반으로 1차 후보군 축소
  - 계층 탐색: 성분 레벨 → 제품 레벨로 매핑(또는 반대)
  - 빔서치/그리디 + 지역 탐색: 빠르게 Top-k 근사
  - 제약 우선: 안전/예산을 먼저 만족하는 작은 후보를 만들고 확장

# 추천 정확도 KPI(80%) 평가 대응(중요)

- 01 문서의 정의는 “약사 그룹 성분 집합 R_i”와 “엔진 조합 성분 합집합 Γ_i”의 일치율이다.
- 따라서 엔진은 “조합 결과를 성분 집합 형태로 변환”할 수 있어야 한다.
- 최소 산출물(권장):
  - case_id(또는 trace_id)
  - output_combo_product_ids
  - output_combo_ingredient_ids (Γ_i)
  - (가능하면) 약사 기준 성분 집합 R_i를 로드/연결하는 키

# 비용/복용 편의성(선택적이지만 흔한 요구)

- 계획서에 “가격 부담”이 문제로 제시되어 있으므로, 비용이 들어오면 활용할 수 있는 확장 포인트를 둔다.
- 예:
  - 월 비용 추정치(제품 단가 + 복용량 기반)
  - 복용 알 수/횟수(편의성)
- 단, 데이터가 없을 수 있으므로 “없을 때는 계산 생략/부분 점수”가 가능해야 한다.

# 로깅/버전(재현성 핵심)

- 엔진 실행마다 아래를 남기면 추후 데이터 구조 변경에도 평가가 유지된다.
  - trace_id, user_profile_ref(가명/해시 가능)
  - candidate_set_version (후보 아이템 스냅샷)
  - safety_constraints_version (03 결과 버전/룰셋 버전)
  - scoring_config_version (가중치/설정)
  - algorithm_version (탐색 알고리즘 버전)
  - top_k_results (제품/성분 조합, 점수, 제약 충족 여부, 비용/위험 관련 값)
- “같은 입력이면 같은 출력”이 되도록, 랜덤이 있다면 seed도 기록한다.

# 개인정보/민감정보

- 최적화 입력에는 건강 목표/질환/복용약 등 민감정보가 포함될 수 있다.
- 로그에는 원문을 최소화하고 표준 키/해시/요약 중심으로 남기는 것을 권장한다.

# 완료 체크리스트(구현팀용)

- 안전 제약을 위반하지 않는 Top-k가 산출된다.
- 각 후보에 대한 점수/근거/제약 충족 정보가 기록된다.
- KPI 평가용 성분 집합(Γ_i) 출력이 가능하다.
- 후보/제약/설정/알고리즘 버전이 기록되어 재현 가능하다.
