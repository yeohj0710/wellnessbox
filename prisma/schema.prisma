generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider  = "postgresql"
  url       = env("WELLNESSBOX_PRISMA_URL")
  directUrl = env("WELLNESSBOX_URL_NON_POOLING")
}

model Category {
  id         Int       @id @default(autoincrement())
  name       String?
  image      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt
  importance Float?
  products   Product[] @relation("CategoryProductRelation")
}

model Product {
  id               Int               @id @default(autoincrement())
  name             String?
  images           String[]
  description      String?
  rating           Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @default(now()) @updatedAt
  importance       Float?
  pharmacyProducts PharmacyProduct[]
  reviews          Review[]
  categories       Category[]        @relation("CategoryProductRelation")
}

model Pharmacy {
  id                 Int               @id @default(autoincrement())
  name               String?
  address            String?
  phone              String?
  userId             String?
  password           String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @default(now()) @updatedAt
  registrationNumber String?
  representativeName String?
  messages           Message[]
  orders             Order[]
  pharmacyProducts   PharmacyProduct[]
  subscriptions      Subscription[]
}

model PharmacyProduct {
  id         Int         @id @default(autoincrement())
  optionType String?
  price      Int?
  stock      Int?
  capacity   String?
  pharmacyId Int?
  productId  Int?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @default(now()) @updatedAt
  importance Float?
  orderItems OrderItem[]
  pharmacy   Pharmacy?   @relation(fields: [pharmacyId], references: [id])
  product    Product?    @relation(fields: [productId], references: [id])
}

model Order {
  id               Int            @id @default(autoincrement())
  roadAddress      String?
  detailAddress    String?
  phone            String?
  password         String?
  requestNotes     String?
  entrancePassword String?
  directions       String?
  paymentId        String?
  transactionType  String?
  txId             String?
  totalPrice       Int?
  status           String?
  pharmacyId       Int?
  riderId          Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  endpoint         String?
  appUserId        String?
  messages         Message[]
  pharmacy         Pharmacy?      @relation(fields: [pharmacyId], references: [id])
  rider            Rider?         @relation(fields: [riderId], references: [id])
  orderItems       OrderItem[]
  reviews          Review[]
  subscriptions    Subscription[]
  appUser          AppUser?        @relation(fields: [appUserId], references: [id], onDelete: SetNull)

  @@index([appUserId, createdAt])
  @@index([phone, createdAt])
  @@index([phone, password, createdAt])
  @@index([paymentId])
}

model OrderItem {
  id                Int              @id @default(autoincrement())
  quantity          Int?
  orderId           Int?
  pharmacyProductId Int?
  reviewId          Int?             @unique
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt
  order             Order?           @relation(fields: [orderId], references: [id])
  pharmacyProduct   PharmacyProduct? @relation(fields: [pharmacyProductId], references: [id])
  review            Review?
}

model Message {
  id         Int       @id @default(autoincrement())
  orderId    Int?
  content    String?
  timestamp  DateTime  @default(now())
  pharmacyId Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt
  order      Order?    @relation(fields: [orderId], references: [id])
  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id])

  @@index([orderId, id])
}

model Rider {
  id            Int            @id @default(autoincrement())
  phone         String?
  userId        String?
  password      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt
  orders        Order[]
  subscriptions Subscription[]
}

model Review {
  id          Int        @id @default(autoincrement())
  rate        Float?
  content     String?
  images      String[]
  orderId     Int?
  productId   Int?
  orderItemId Int?       @unique
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt
  order       Order?     @relation(fields: [orderId], references: [id])
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id])
  product     Product?   @relation(fields: [productId], references: [id])
}

model Subscription {
  id         Int       @id @default(autoincrement())
  endpoint   String
  auth       String
  p256dh     String
  orderId    Int?
  invalidatedAt DateTime?
  lastFailureStatus Int?
  createdAt  DateTime  @default(now())
  pharmacyId Int?
  role       String
  riderId    Int?
  order      Order?    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  rider      Rider?    @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@unique([role, orderId, endpoint])
  @@unique([role, pharmacyId, endpoint])
  @@unique([role, riderId, endpoint])
}

model PushDelivery {
  id              Int       @id @default(autoincrement())
  eventKey        String
  role            String
  endpoint        String
  status          String    @default("pending")
  orderId         Int?
  pharmacyId      Int?
  riderId         Int?
  errorType       String?
  errorStatusCode Int?
  deliveredAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  @@unique([eventKey, role, endpoint])
  @@index([role, createdAt])
  @@index([orderId, createdAt])
  @@index([pharmacyId, createdAt])
  @@index([riderId, createdAt])
}

model Client {
  id             String             @id
  userAgent      String?
  lastIpHash     String?
  pushEndpoint   String?
  createdAt      DateTime           @default(now())
  lastSeenAt     DateTime           @default(now())
  assessResults  AssessmentResult[]
  chatSessions   ChatSession[]
  checkAiResults CheckAiResult[]
  profile        UserProfile?
  appUsers       AppUser[]

  @@index([lastSeenAt])
}

model AssessmentResult {
  id              String   @id @default(cuid())
  clientId        String
  appUserId       String?
  answers         Json
  cResult         Json
  questionSnapshot Json?
  scoreSnapshot   Json?
  tzOffsetMinutes Int      @default(0)
  createdAt       DateTime @default(now())
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appUser         AppUser? @relation(fields: [appUserId], references: [id], onDelete: SetNull)

  @@index([clientId, createdAt])
  @@index([appUserId, createdAt])
}

model CheckAiResult {
  id              String   @id @default(cuid())
  clientId        String
  appUserId       String?
  result          Json
  questionSnapshot Json?
  scoreSnapshot   Json?
  tzOffsetMinutes Int      @default(0)
  createdAt       DateTime @default(now())
  answers         Json?
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appUser         AppUser? @relation(fields: [appUserId], references: [id], onDelete: SetNull)

  @@index([clientId, createdAt])
  @@index([appUserId, createdAt])
}

model UserProfile {
  id        String   @id @default(cuid())
  clientId  String   @unique
  data      Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, updatedAt])
}

model AppUser {
  id              String    @id @default(cuid())
  kakaoId         String    @unique
  clientId        String?
  nickname        String?
  email           String?
  profileImageUrl String?
  kakaoEmail      String?
  phone           String?
  phoneLinkedAt   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  assessResults   AssessmentResult[]
  checkAiResults  CheckAiResult[]
  emailOtps       EmailOtp[]
  orders          Order[]
  chatSessions    ChatSession[]
  healthProviderLinks HealthProviderLink[]
  healthProviderFetchCaches HealthProviderFetchCache[]
  healthProviderFetchAttempts HealthProviderFetchAttempt[]

  @@index([clientId])
  @@index([email])
  @@index([phone])
}

model HealthProviderLink {
  id               String   @id @default(cuid())
  appUserId        String
  provider         String
  linked           Boolean  @default(false)
  loginMethod      String?
  loginOrgCd       String?
  stepMode         String?
  stepData         Json?
  cookieData       Json?
  lastIdentityHash String?
  lastLinkedAt     DateTime?
  lastFetchedAt    DateTime?
  lastErrorCode    String?
  lastErrorMessage String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt
  appUser          AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)

  @@unique([appUserId, provider])
  @@index([provider, linked])
  @@index([appUserId, updatedAt])
}

model HealthProviderFetchCache {
  id            String   @id @default(cuid())
  appUserId     String
  provider      String
  identityHash  String
  requestHash   String
  requestKey    String
  targets       String[]
  yearLimit     Int?
  fromDate      String?
  toDate        String?
  subjectType   String?
  statusCode    Int
  ok            Boolean
  partial       Boolean  @default(false)
  payload       Json
  fetchedAt     DateTime @default(now())
  expiresAt     DateTime
  hitCount      Int      @default(0)
  lastHitAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  appUser       AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)

  @@unique([appUserId, provider, requestHash])
  @@index([appUserId, provider, expiresAt])
  @@index([provider, identityHash, expiresAt])
  @@index([appUserId, fetchedAt])
}

model HealthProviderFetchAttempt {
  id           String   @id @default(cuid())
  appUserId    String
  provider     String
  identityHash String?
  requestHash  String?
  requestKey   String?
  forceRefresh Boolean  @default(false)
  cached       Boolean  @default(false)
  statusCode   Int?
  ok           Boolean?
  createdAt    DateTime @default(now())
  appUser      AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)

  @@index([appUserId, provider, createdAt])
  @@index([appUserId, provider, forceRefresh, createdAt])
  @@index([provider, createdAt])
}

model ChatSession {
  id        String        @id
  clientId  String
  appUserId String?
  title     String
  status    String        @default("active")
  meta      Json?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt
  messages  ChatMessage[]
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appUser   AppUser?      @relation(fields: [appUserId], references: [id], onDelete: SetNull)

  @@index([clientId, updatedAt])
  @@index([appUserId, updatedAt])
}

model ChatMessage {
  id              String      @id
  sessionId       String
  role            ChatRole
  content         String
  tokensIn        Int?
  tokensOut       Int?
  meta            Json?
  tzOffsetMinutes Int         @default(0)
  createdAt       DateTime    @default(now())
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

model Config {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhoneOtp {
  id        String    @id @default(cuid())
  phone     String
  codeHash  String
  expiresAt DateTime
  usedAt    DateTime?
  attempts  Int       @default(0)
  createdAt DateTime  @default(now())

  @@index([phone, createdAt])
  @@index([expiresAt])
}

model EmailOtp {
  id             String    @id @default(cuid())
  userId         String
  email          String
  codeHash       String
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  usedAt         DateTime?
  attemptCount   Int       @default(0)
  lastAttemptAt  DateTime?
  sendCount      Int       @default(1)
  lastSentAt     DateTime  @default(now())
  user           AppUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, email, createdAt])
  @@index([userId, email, expiresAt])
  @@index([userId, email, usedAt, expiresAt])
}

model AppLoginTransferToken {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  payload    Json
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())
}

/// DB에 이미 있는 vector 테이블 유지 (drop 위험 방지)
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model rag_chunks {
  id        String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  text      String?
  metadata  Json?
  embedding Unsupported("vector")?
}

enum ChatRole {
  system
  user
  assistant
}
